name: Deploy Lambdas via CodeDeploy (Python 3.11)

on:
  push:
    branches: [ main ]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-2
  ROLE_ARN: arn:aws:iam::963604113709:role/GitHubActionsDeployRole
  LAMBDA_ALIAS: live

jobs:
  deploy:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - function: putModel
            cd_app: acmemodels-lambda-app
            cd_dg: acmemodels-lambda-dg
          - function: getModel
            cd_app: acmemodels-getmodel-app
            cd_dg: acmemodels-getmodel-dg

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements-deploy.txt ]; then
            pip install -r requirements-deploy.txt -t .lambda_pkgs
          elif [ -f requirements.txt ]; then
            pip install -r requirements.txt -t .lambda_pkgs
          fi

      - name: Create deployment zip
        run: |
          mkdir -p build
          ZIP="build/${{ matrix.function }}.zip"
          rm -f "$ZIP"
          if [ -d .lambda_pkgs ]; then (cd .lambda_pkgs && zip -r "../${ZIP}" . -x "*/__pycache__/*" "*.dist-info/*" ".DS_Store"); fi
          zip -gr "$ZIP" src -x "*/__pycache__/*" "*.pyc" ".DS_Store"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update Lambda code (publish new version)
        id: update
        run: |
          aws lambda update-function-code \
            --function-name "${{ matrix.function }}" \
            --zip-file "fileb://build/${{ matrix.function }}.zip" \
            --publish > update.json
          cat update.json

      - name: Get current & target versions
        id: vers
        run: |
          CUR=$(aws lambda get-alias --function-name "${{ matrix.function }}" --name "${{ env.LAMBDA_ALIAS }}" --query 'FunctionVersion' --output text)
          TGT=$(jq -r '.Version' update.json)
          echo "CUR=$CUR" >> $GITHUB_OUTPUT
          echo "TGT=$TGT" >> $GITHUB_OUTPUT
          echo "Current=$CUR  Target=$TGT"

      - name: Build AppSpec & revision JSON
        run: |
          # Build the AppSpec object
          jq -n \
            --arg fn "${{ matrix.function }}" \
            --arg al "${{ env.LAMBDA_ALIAS }}" \
            --arg cur "${{ steps.vers.outputs.CUR }}" \
            --arg tgt "${{ steps.vers.outputs.TGT }}" \
            '{version:0.0,
              Resources:[
                {myLambdaFunction:{
                  Type:"AWS::Lambda::Function",
                  Properties:{Name:$fn, Alias:$al, CurrentVersion:$cur, TargetVersion:$tgt}
                }}
              ]}' > appspec.json
      
          # Encode AppSpec as a JSON string for CodeDeploy
          APPSTR=$(jq -Rs . < appspec.json)
      
          # IMPORTANT: include revisionType = AppSpecContent (and lowercase keys inside)
          jq -n --argjson content "$APPSTR" \
            '{revisionType:"AppSpecContent", appSpecContent:{content:$content}}' > revision.json
      
          echo "AppSpec:" && cat appspec.json
          echo "Revision wrapper:" && cat revision.json


      - name: Trigger CodeDeploy canary
        run: |
          aws deploy create-deployment \
            --application-name "${{ matrix.cd_app }}" \
            --deployment-group-name "${{ matrix.cd_dg }}" \
            --deployment-config-name CodeDeployDefault.LambdaCanary10Percent5Minutes \
            --revision file://revision.json
